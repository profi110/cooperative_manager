{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <title>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –º–µ—à–∫–∞–Ω—Ü—è</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body style="background-color: #f4f7f6;">
    <div class="container" style="max-width: 700px; margin-top: 50px; margin-bottom: 50px;">
        <div class="card shadow border-0" style="padding: 30px; border-radius: 20px; background: white;">
            <h2 class="text-center font-weight-bold" style="color: #2c3e50;">üìù –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
            <p class="text-center text-muted small">–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –¥–∞–Ω—ñ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ —Å–∏—Å—Ç–µ–º–∏</p>
            <hr>

            <form method="post" id="registrationForm">
                {% csrf_token %}

                <div class="row">
                    <div class="col-md-4 form-group">
                        <label><strong>{{ form.last_name.label }}</strong></label>
                        {{ form.last_name }}
                        <div class="text-danger small">{{ form.last_name.errors }}</div>
                    </div>
                    <div class="col-md-4 form-group">
                        <label><strong>{{ form.first_name.label }}</strong></label>
                        {{ form.first_name }}
                        <div class="text-danger small">{{ form.first_name.errors }}</div>
                    </div>
                    <div class="col-md-4 form-group">
                        <label><strong>{{ form.middle_name.label }}</strong></label>
                        {{ form.middle_name }}
                        <div class="text-danger small">{{ form.middle_name.errors }}</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 form-group">
                        <label><strong>{{ form.phone_number.label }}</strong></label>
                        {{ form.phone_number }}
                        <span id="phone-error" class="text-danger small d-block"></span>
                        <div class="text-danger small">{{ form.phone_number.errors }}</div>
                    </div>
                    <div class="col-md-6 form-group">
                        <label><strong>–õ–æ–≥—ñ–Ω (username)</strong></label>
                        {{ form.username }}
                        <span id="username-error" class="text-danger small d-block"></span>
                        <div class="text-danger small">{{ form.username.errors }}</div>
                    </div>
                </div>

                <div class="p-3 mb-3" style="background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <div class="form-group">
                        <label><strong>{{ form.coop_id.label }}</strong></label>
                        {{ form.coop_id }}
                    </div>
                    <div id="coop-info" style="margin: 10px 0; padding: 10px; border-radius: 5px; display: none;">
                        <span id="coop-message"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8 form-group">
                        <label><strong>{{ form.street.label }}</strong></label>
                        {{ form.street }}
                    </div>
                    <div class="col-md-4 form-group">
                        <label><strong>{{ form.house_number.label }}</strong></label>
                        {{ form.house_number }}
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>–ü–∞—Ä–æ–ª—å</strong></label>
                    {{ form.password1 }}
                </div>
                <div class="form-group">
                    <label><strong>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—è</strong></label>
                    {{ form.password2 }}
                </div>

                <button type="submit" id="submitBtn" class="btn btn-success mt-3" style="width: 100%; padding: 12px; background-color: #2ecc71; border: none; color: white; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.1rem; transition: 0.3s;">
                    üöÄ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞—è–≤–∫—É
                </button>
            </form>
        </div>
        <p class="text-center mt-3">–í–∂–µ –º–∞—î—Ç–µ –∞–∫–∞—É–Ω—Ç? <a href="{% url 'login' %}" style="color: #2ecc71; font-weight: bold;">–£–≤—ñ–π—Ç–∏</a></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // –ï–ª–µ–º–µ–Ω—Ç–∏ —Ñ–æ—Ä–º–∏
            const coopInput = document.getElementById('id_coop_id');
            const streetSelect = document.getElementById('id_street');
            const infoBox = document.getElementById('coop-info');
            const messageSpan = document.getElementById('coop-message');
            const usernameInput = document.getElementById('id_username');
            const phoneInput = document.getElementById('id_phone_number');
            const usernameError = document.getElementById('username-error');
            const phoneError = document.getElementById('phone-error');
            const submitBtn = document.getElementById('submitBtn');

            // –°—Ç–∞–Ω –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
            let validation = {
                coop: false,
                username: false,
                phone: false
            };

            // –§—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É —Ñ–æ—Ä–º–∏
            function toggleSubmit() {
                submitBtn.disabled = !(validation.coop && validation.username && validation.phone);
            }

            // 1. –ü–ï–†–ï–í–Ü–†–ö–ê –ö–û–û–ü–ï–†–ê–¢–ò–í–£ (—á–µ—Ä–µ–∑ fetch)
            coopInput.addEventListener('input', function() {
                const coopId = this.value;
                if (coopId.length > 0) {
                    fetch(`{% url 'check_coop_id' %}?coop_id=${coopId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.exists) {
                                infoBox.style.display = 'block';
                                infoBox.style.backgroundColor = '#d4edda';
                                infoBox.style.color = '#155724';
                                messageSpan.textContent = "‚úÖ –ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤ –∑–Ω–∞–π–¥–µ–Ω–æ: " + data.name;

                                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—É–ª–∏—Ü—å
                                streetSelect.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –≤—É–ª–∏—Ü—é --</option>';
                                data.streets.forEach(street => {
                                    const option = document.createElement('option');
                                    option.value = street;
                                    option.textContent = street;
                                    streetSelect.appendChild(option);
                                });
                                validation.coop = true;
                            } else {
                                infoBox.style.display = 'block';
                                infoBox.style.backgroundColor = '#f8d7da';
                                infoBox.style.color = '#721c24';
                                messageSpan.textContent = "‚ùå –ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤ –Ω–µ —ñ—Å–Ω—É—î";
                                streetSelect.innerHTML = '<option value="">---------</option>';
                                validation.coop = false;
                            }
                            toggleSubmit();
                        });
                } else {
                    infoBox.style.display = 'none';
                    validation.coop = false;
                    toggleSubmit();
                }
            });

            // 2. –ü–ï–†–ï–í–Ü–†–ö–ê –î–£–ë–õ–Ü–ö–ê–¢–Ü–í (–õ–æ–≥—ñ–Ω —Ç–∞ –¢–µ–ª–µ—Ñ–æ–Ω)
            function checkDuplicate(inputElement, errorElement, paramName, validationKey) {
                const value = inputElement.value;
                if (value.length < 3) {
                    errorElement.textContent = "";
                    inputElement.style.borderColor = "";
                    validation[validationKey] = false;
                    toggleSubmit();
                    return;
                }

                fetch(`{% url 'api_check_duplicates' %}?${paramName}=${encodeURIComponent(value)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.is_taken) {
                            inputElement.style.borderColor = "red";
                            errorElement.textContent = "‚ùå –í–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è";
                            validation[validationKey] = false;
                        } else {
                            inputElement.style.borderColor = "#2ecc71";
                            errorElement.textContent = "";
                            validation[validationKey] = true;
                        }
                        toggleSubmit();
                    })
                    .catch(err => console.error('–ü–æ–º–∏–ª–∫–∞ API:', err));
            }

            usernameInput.addEventListener('input', () =>
                checkDuplicate(usernameInput, usernameError, 'username', 'username'));

            phoneInput.addEventListener('input', () =>
                checkDuplicate(phoneInput, phoneError, 'phone', 'phone'));
        });
    </script>
</body>
</html>