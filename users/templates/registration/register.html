{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <title>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –º–µ—à–∫–∞–Ω—Ü—è</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body style="background-color: #f4f7f6;">
    <div class="container" style="max-width: 700px; margin-top: 50px; margin-bottom: 50px;">
        <div class="card shadow border-0" style="padding: 30px; border-radius: 20px; background: white;">
            <h2 class="text-center font-weight-bold" style="color: #2c3e50;">üìù –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
            <p class="text-center text-muted small">–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –¥–∞–Ω—ñ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ —Å–∏—Å—Ç–µ–º–∏</p>
            <hr>

            {% if form.errors %}
                <div class="alert alert-danger" style="border-radius: 10px;">
                    <ul class="mb-0">
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <form method="post" id="registrationForm">
                {% csrf_token %}

                <div class="row">
                    <div class="col-md-4 form-group">
                        <label><strong>{{ form.last_name.label }}</strong></label>
                        {{ form.last_name }}
                    </div>
                    <div class="col-md-4 form-group">
                        <label><strong>{{ form.first_name.label }}</strong></label>
                        {{ form.first_name }}
                    </div>
                    <div class="col-md-4 form-group">
                        <label><strong>{{ form.middle_name.label }}</strong></label>
                        {{ form.middle_name }}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 form-group">
                        <label><strong>{{ form.phone_number.label }}</strong></label>
                        {{ form.phone_number }}
                        <span id="phone-error" class="text-danger small d-block"></span>
                    </div>
                    <div class="col-md-6 form-group">
                        <label><strong>–õ–æ–≥—ñ–Ω (username)</strong></label>
                        {{ form.username }}
                        <span id="username-error" class="text-danger small d-block"></span>
                    </div>
                </div>

                <div class="p-3 mb-3" style="background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <div class="form-group">
                        <label><strong>{{ form.coop_id.label }}</strong></label>
                        {{ form.coop_id }}
                    </div>
                    <div id="coop-info" style="margin: 10px 0; padding: 10px; border-radius: 5px; display: none;">
                        <span id="coop-message"></span>
                    </div>
                    <div class="form-group">
                        <label><strong>{{ form.street.label }}</strong></label>
                        {{ form.street }}
                        <div class="text-danger small">{{ form.street.errors }}</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 form-group">
                        <label><strong>{{ form.house_number.label }}</strong></label>
                        {{ form.house_number }}
                    </div>
                </div>

                <div class="form-group">
                    <label><strong>–ü–∞—Ä–æ–ª—å</strong></label>
                    {{ form.password1 }}
                    <div class="text-danger small">{{ form.password1.errors }}</div>
                </div>
                <div class="form-group">
                    <label><strong>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—è</strong></label>
                    {{ form.password2 }}
                    <div class="text-danger small">{{ form.password2.errors }}</div>
                </div>

                <button type="submit" id="submitBtn" class="btn btn-success mt-3" style="width: 100%; padding: 12px; font-weight: bold;">
                    üöÄ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞—è–≤–∫—É
                </button>
            </form>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
        const coopInput = document.getElementById('id_coop_id');
        const streetSelect = document.getElementById('id_street');
        const infoBox = document.getElementById('coop-info');
        const messageSpan = document.getElementById('coop-message');
        const usernameInput = document.getElementById('id_username');
        const phoneInput = document.getElementById('id_phone_number');
        const usernameError = document.getElementById('username-error');
        const phoneError = document.getElementById('phone-error');
        const submitBtn = document.getElementById('submitBtn');

        let validation = { coop: false, username: false, phone: false };

        // –†–µ–≥—É–ª—è—Ä–Ω—ñ –≤–∏—Ä–∞–∑–∏ –¥–ª—è –º–∏—Ç—Ç—î–≤–æ—ó —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó
        const PHONE_REGEX = /^\+?380\d{9}$|^0\d{9}$/;
        const USERNAME_REGEX = /^[a-zA-Z0-9.@+/-/_]{3,}$/;

        // –§—É–Ω–∫—Ü—ñ—è Debounce –¥–ª—è –∑–º–µ–Ω—à–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        function debounce(func, timeout = 800) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        function toggleSubmit() {
            submitBtn.disabled = !(validation.coop && validation.username && validation.phone);
            submitBtn.style.opacity = submitBtn.disabled ? "0.6" : "1";
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—é Regex-—Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—î—é
        function checkDuplicate(inputElement, errorElement, paramName, validationKey) {
            const value = inputElement.value;

            // –ö–ª—ñ—î–Ω—Ç—Å—å–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –ü–ï–†–ï–î –∑–∞–ø–∏—Ç–æ–º fetch
            if (paramName === 'phone') {
                if (!PHONE_REGEX.test(value)) {
                    inputElement.style.borderColor = "orange";
                    errorElement.textContent = "‚ö†Ô∏è –ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç (+380...)";
                    validation[validationKey] = false;
                    toggleSubmit();
                    return; // –ó—É–ø–∏–Ω—è—î–º–æ, –∑–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –Ω–µ –π–¥–µ
                }
            }

            if (paramName === 'username') {
                if (!USERNAME_REGEX.test(value)) {
                    inputElement.style.borderColor = "orange";
                    errorElement.textContent = "‚ö†Ô∏è –í—ñ–¥ 3 —Å–∏–º–≤–æ–ª—ñ–≤ (–ª–∞—Ç–∏–Ω–∏—Ü—è/—Ü–∏—Ñ—Ä–∏)";
                    validation[validationKey] = false;
                    toggleSubmit();
                    return;
                }
            }

            // –Ø–∫—â–æ Regex –ø—Ä–æ–π–¥–µ–Ω–æ ‚Äî —Ä–æ–±–∏–º–æ –∑–∞–ø–∏—Ç –¥–æ –ë–î
            fetch(`{% url 'api_check_duplicates' %}?${paramName}=${encodeURIComponent(value)}`)
                .then(response => {
                    if (response.status === 429) {
                        errorElement.textContent = "‚ö†Ô∏è –ó–∞–±–∞–≥–∞—Ç–æ —Å–ø—Ä–æ–±! –ü–æ—á–µ–∫–∞–π—Ç–µ –≥–æ–¥–∏–Ω—É.";
                        return null;
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    if (data.is_taken) {
                        inputElement.style.borderColor = "red";
                        errorElement.textContent = "‚ùå –í–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è";
                        validation[validationKey] = false;
                    } else {
                        inputElement.style.borderColor = "#2ecc71";
                        errorElement.textContent = "";
                        validation[validationKey] = true;
                    }
                    toggleSubmit();
                });
        }

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–µ–±–∞—É–Ω—Å-–≤–µ—Ä—Å—ñ–π –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫
        const debouncedCheck = debounce((el, err, param, key) => checkDuplicate(el, err, param, key));

        // –°–ª—É—Ö–∞—á—ñ –ø–æ–¥—ñ–π
        coopInput.addEventListener('input', function() {
            const coopId = this.value;
            if (coopId.length > 0) {
                fetch(`{% url 'check_coop_id' %}?coop_id=${coopId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            infoBox.style.display = 'block';
                            infoBox.style.backgroundColor = '#d4edda';
                            infoBox.style.color = '#155724';
                            messageSpan.textContent = "‚úÖ –ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤ –∑–Ω–∞–π–¥–µ–Ω–æ: " + data.name;

                            const currentStreet = streetSelect.value;
                            streetSelect.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –≤—É–ª–∏—Ü—é --</option>';
                            data.streets.forEach(street => {
                                const option = document.createElement('option');
                                option.value = street;
                                option.textContent = street;
                                if (street === currentStreet) option.selected = true;
                                streetSelect.appendChild(option);
                            });
                            validation.coop = true;
                        } else {
                            infoBox.style.display = 'block';
                            infoBox.style.backgroundColor = '#f8d7da';
                            infoBox.style.color = '#721c24';
                            messageSpan.textContent = "‚ùå –ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤ –Ω–µ —ñ—Å–Ω—É—î";
                            streetSelect.innerHTML = '<option value="">---------</option>';
                            validation.coop = false;
                        }
                        toggleSubmit();
                    });
            } else {
                infoBox.style.display = 'none';
                validation.coop = false;
                toggleSubmit();
            }
        });

        usernameInput.addEventListener('input', () => {
            usernameInput.style.borderColor = "";
            debouncedCheck(usernameInput, usernameError, 'username', 'username');
        });

        phoneInput.addEventListener('input', () => {
            phoneInput.style.borderColor = "";
            debouncedCheck(phoneInput, phoneError, 'phone', 'phone');
        });

        // –ü–æ—á–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ (—è–∫—â–æ –¥–∞–Ω—ñ –≤–∂–µ —î –≤ –ø–æ–ª—è—Ö)
        function runInitialValidation() {
            if (coopInput.value.length > 0) coopInput.dispatchEvent(new Event('input'));
            if (usernameInput.value.length >= 3) checkDuplicate(usernameInput, usernameError, 'username', 'username');
            if (phoneInput.value.length >= 3) checkDuplicate(phoneInput, phoneError, 'phone', 'phone');
        }

        runInitialValidation();
    });
</script>
</body>
</html>